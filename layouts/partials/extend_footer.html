<script>
(function() {
  fetch('/api/subscribers')
    .then(function(r) { return r.json(); })
    .then(function(d) {
      if (d.count > 0) {
        var links = document.querySelectorAll('.social-icons a');
        links.forEach(function(a) {
          if (a.href && a.href.indexOf('kit.com') !== -1) {
            var span = document.createElement('span');
            span.style.cssText = 'font-size:0.65em;opacity:0.6;margin-left:-2px;vertical-align:sub;';
            span.textContent = '(' + d.count + ')';
            a.parentNode.insertBefore(span, a.nextSibling);
          }
        });
      }
    })
    .catch(function() {});
})();
</script>
<!-- Theme Picker JS -->
<script>
(function() {
  var THEMES = [
    { name: 'default', label: 'Default', light: '#ffffff', dark: '#1d1e20', border: '#eeeeee' },
    { name: 'terminal', label: 'Terminal', light: '#f0f0e8', dark: '#0a0e0a', border: '#b8c0b0' },
    { name: 'manuscript', label: 'Manuscript', light: '#faf7f0', dark: '#1c1a16', border: '#ddd5c8' },
    { name: 'blueprint', label: 'Blueprint', light: '#f4f6fa', dark: '#0c1220', border: '#bcc6dd' },
    { name: 'amber', label: 'Amber', light: '#faf5ee', dark: '#12100a', border: '#daccb0' },
    { name: 'claude', label: 'Claude', light: '#faf8f6', dark: '#1a1714', border: '#e0d4c8' },
    { name: 'magazine', label: 'Magazine', light: '#ffffff', dark: '#111111', border: '#d0d0d0' },
    { name: 'brutalist', label: 'Brutalist', light: '#ffffff', dark: '#0a0a0a', border: '#000000' },
    { name: 'e-ink', label: 'E-ink', light: '#f9f9f6', dark: '#1a1a18', border: '#cccccc' },
    { name: 'cyberpunk', label: 'Cyberpunk', light: '#e8eaf0', dark: '#0a0a14', border: '#8080aa' },
    { name: 'colorful', label: 'Colorful', light: '#fffbf5', dark: '#110e20', border: '#e0d0f0' },
    { name: 'custom', label: 'Custom...', light: '#888888', dark: '#444444', border: '#888888', isCustom: true }
  ];

  var currentTheme = localStorage.getItem('full-theme') || 'default';
  var dropdown = document.getElementById('theme-picker-dropdown');
  var btn = document.getElementById('theme-picker-btn');
  if (!dropdown || !btn) return;

  function clearCustomInlineStyles() {
    var html = document.documentElement;
    var cssVars = ['--theme','--entry','--primary','--secondary','--tertiary','--content','--code-block-bg','--code-bg','--border','--main-width','--gap','--content-gap','--radius'];
    cssVars.forEach(function(v) { html.style.removeProperty(v); });
    // Remove effect classes
    html.className = html.className.split(' ').filter(function(c) { return c && c.indexOf('effect-') !== 0; }).join(' ');
    // Remove custom style element
    var customStyle = document.getElementById('custom-theme-style');
    if (customStyle) customStyle.remove();
  }

  function buildDropdown() {
    dropdown.innerHTML = '';
    THEMES.forEach(function(t) {
      var option = document.createElement('button');
      option.className = 'theme-option' + (t.name === currentTheme ? ' active' : '');
      option.setAttribute('data-theme-name', t.name);
      option.innerHTML =
        '<span class="theme-preview" style="background:' + t.light + ';border:1px solid ' + t.border + '">' +
        '<span class="theme-preview-dark" style="background:' + t.dark + '"></span></span>' +
        '<span class="theme-label">' + t.label + '</span>' +
        '<span class="theme-check">&#10003;</span>';
      option.addEventListener('click', function() {
        if (t.isCustom) {
          var hasSettings = localStorage.getItem('custom-theme-settings');
          if (hasSettings) {
            setTheme('custom');
          } else {
            window.location.href = '/theme-studio/';
          }
        } else {
          setTheme(t.name);
        }
      });
      dropdown.appendChild(option);
    });
  }

  function setTheme(name) {
    currentTheme = name;
    localStorage.setItem('full-theme', name);
    document.documentElement.setAttribute('data-full-theme', name);
    if (name !== 'custom') {
      clearCustomInlineStyles();
    } else {
      // Re-apply custom settings from localStorage
      try {
        var s = JSON.parse(localStorage.getItem('custom-theme-settings'));
        if (s) {
          var html = document.documentElement;
          var isDark = html.getAttribute('data-theme') === 'dark';
          var c = isDark ? s.colors.dark : s.colors.light;
          if (c) { for (var k in c) { if (c.hasOwnProperty(k)) html.style.setProperty('--' + k, c[k]); } }
          if (s.layout) {
            html.style.setProperty('--main-width', s.layout.mainWidth + 'px');
            html.style.setProperty('--gap', s.layout.gap + 'px');
            html.style.setProperty('--content-gap', s.layout.contentGap + 'px');
            html.style.setProperty('--radius', s.layout.radius + 'px');
          }
        }
      } catch(e) {}
    }
    buildDropdown();
    dropdown.classList.add('hidden');
  }

  buildDropdown();

  btn.addEventListener('click', function(e) {
    e.stopPropagation();
    dropdown.classList.toggle('hidden');
  });

  document.addEventListener('click', function(e) {
    if (!dropdown.contains(e.target) && e.target !== btn) {
      dropdown.classList.add('hidden');
    }
  });

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      dropdown.classList.add('hidden');
    }
  });
})();
</script>
{{ if .IsPage }}
<div class="reading-progress" id="reading-progress"></div>
<script>
(function() {
  var bar = document.getElementById('reading-progress');
  if (!bar) return;
  window.addEventListener('scroll', function() {
    var h = document.documentElement;
    var scrollTop = h.scrollTop || document.body.scrollTop;
    var scrollHeight = h.scrollHeight - h.clientHeight;
    if (scrollHeight > 0) {
      bar.style.width = (scrollTop / scrollHeight * 100) + '%';
    }
  });
})();
</script>
<!-- TOC Scroll-Spy -->
<script>
(function() {
  var tocLinks = document.querySelectorAll('[data-toc-link]');
  if (tocLinks.length === 0) return;

  var headings = Array.from(tocLinks).map(function(link) {
    var id = link.getAttribute('data-toc-link');
    return document.querySelector(id);
  }).filter(function(h) { return h !== null; });

  if (headings.length === 0) return;

  var observer = new IntersectionObserver(function(entries) {
    entries.forEach(function(entry) {
      if (entry.isIntersecting) {
        tocLinks.forEach(function(link) { link.classList.remove('active'); });
        var activeLink = document.querySelector('[data-toc-link="#' + entry.target.id + '"]');
        if (activeLink) activeLink.classList.add('active');
      }
    });
  }, { rootMargin: '-20% 0px -35% 0px' });

  headings.forEach(function(heading) { observer.observe(heading); });

  // Smooth scroll on TOC link click
  tocLinks.forEach(function(link) {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      var id = link.getAttribute('data-toc-link');
      var target = document.querySelector(id);
      if (target) {
        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });
  });
})();
</script>
{{ end }}
